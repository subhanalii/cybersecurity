{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-column align-items-center" style="min-height:60vh; gap:18px;">
  <div style="max-width:760px; width:100%;">
    <h1 class="title">CyberRecon</h1>
    <p class="lead muted">Enter a domain and click <strong>Scan</strong>.</p>

    <div class="input-group mb-3">
      <input id="targetInput" type="text" class="form-control form-control-dark" placeholder="example.com" aria-label="target">
      <button id="scanBtn" class="btn btn-primary">Scan</button>
    </div>

    <div id="message" class="muted small">No scan yet.</div>
  </div>

  <!-- Results area hidden until after scan -->
  <div id="results" style="width:100%; max-width:1100px; display:none;">
    <div class="panel p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="muted small">Target</div>
          <div id="targetTitle" class="kpi">—</div>
        </div>
        <div class="text-end">
          <div class="muted small">Scan time</div>
          <div id="scanTime" class="muted small">—</div>
        </div>
      </div>

      <div id="terminal" class="terminal mt-3">Scanning...</div>
    </div>

    <div class="panel p-3 mb-3">
      <div class="row g-3">
        <div class="col-md-6">
          <h6 class="small muted">A records</h6>
          <pre id="aRecords" class="cmd">—</pre>
        </div>
        <div class="col-md-6">
          <h6 class="small muted">Open ports</h6>
          <pre id="openPorts" class="cmd">—</pre>
        </div>
        <div class="col-md-6">
          <h6 class="small muted">Security headers</h6>
          <pre id="secHeaders" class="cmd">—</pre>
        </div>
        <div class="col-md-6">
          <h6 class="small muted">Missing headers</h6>
          <pre id="missingHeaders" class="cmd">—</pre>
        </div>
      </div>
    </div>

    <div class="panel p-3 mb-3">
      <h6 class="small muted">WHOIS</h6>
      <pre id="whois" class="json-box">—</pre>

      <h6 class="small muted mt-3">Subdomains (crt.sh)</h6>
      <pre id="subdomains" class="json-box">—</pre>

      <h6 class="small muted mt-3">HTML snapshot</h6>
      <pre id="snapshot" class="json-box">—</pre>

      <h6 class="small muted mt-3">Raw summary</h6>
      <pre id="rawJson" class="json-box">—</pre>
    </div>

    <div class="d-flex gap-2">
      <button id="backBtn" class="btn btn-outline-light">New scan</button>
      <a id="openSummary" class="btn btn-light text-dark" href="/summary" target="_blank">Open summary.json</a>
      <a id="openReport" class="btn btn-light text-dark" href="#" target="_blank" style="display:none;">Open Report Page</a>
    </div>
  </div>
</div>

<script>
  const scanBtn = document.getElementById('scanBtn');
  const targetInput = document.getElementById('targetInput');
  const message = document.getElementById('message');
  const results = document.getElementById('results');
  const backBtn = document.getElementById('backBtn');
  const openReport = document.getElementById('openReport');

  function showBusy() {
    message.textContent = 'Scanning — please wait...';
    scanBtn.disabled = true;
    targetInput.disabled = true;
  }
  function hideBusy() {
    message.textContent = '';
    scanBtn.disabled = false;
    targetInput.disabled = false;
  }

  function fillResults(summary) {
    document.getElementById('targetTitle').textContent = summary.domain || '';
    document.getElementById('scanTime').textContent = new Date().toLocaleString();
    document.getElementById('terminal').textContent = '> quick summary complete';
    document.getElementById('aRecords').textContent = (summary.dns && summary.dns.A) ? summary.dns.A.join(', ') : '—';
    document.getElementById('openPorts').textContent = (summary.ports && summary.ports.open) ? (Array.isArray(summary.ports.open) ? summary.ports.open.join(', ') : summary.ports.open) : 'none';
    const headers = summary.headers || {};
    if (typeof headers === 'object' && Object.keys(headers).length) {
      document.getElementById('secHeaders').textContent = JSON.stringify(headers, null, 2);
    } else {
      document.getElementById('secHeaders').textContent = (summary.headers && summary.headers.length)? summary.headers.join(', '): '—';
    }
    document.getElementById('missingHeaders').textContent = (summary.missing_headers && summary.missing_headers.length) ? summary.missing_headers.join(', ') : 'none';
    document.getElementById('whois').textContent = summary.whois ? JSON.stringify(summary.whois, null, 2) : '—';
    document.getElementById('subdomains').textContent = (summary.subdomains && summary.subdomains.length) ? summary.subdomains.join('\n') : 'none';
    document.getElementById('snapshot').textContent = (summary.snapshot && summary.snapshot.ok) ? `saved → ${summary.snapshot.filepath || summary.snapshot.path || summary.snapshot.filepath}` : (summary.snapshot && summary.snapshot.error ? summary.snapshot.error : 'not available');
    document.getElementById('rawJson').textContent = JSON.stringify(summary, null, 2);
  }

  async function doScan(target) {
    showBusy();
    message.textContent = 'Scanning — please wait...';
    try {
      const res = await fetch('/scan', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({target})
      });
      const obj = await res.json();
      if (!res.ok || !obj.ok) {
        message.textContent = 'Scan failed: ' + (obj.error || 'unknown');
        hideBusy();
        return;
      }

      // show results area
      results.style.display = 'block';
      document.getElementById('targetTitle').textContent = target;
      fillResults(obj.summary);
      message.textContent = 'Scan complete';

      // prepare report link (pretty page)
      const reportUrl = obj.report_file || `/report/${encodeURIComponent(target)}`;
      // obj.report_file is /reports/<file>; derive domain page link:
      openReport.href = `/report/${encodeURIComponent(target)}`;
      openReport.style.display = 'inline-block';
      // enable open summary button (always points to /summary which holds latest)
      document.getElementById('openSummary').href = '/summary';
    } catch (e) {
      message.textContent = 'Network error: ' + e;
    } finally {
      hideBusy();
    }
  }

  scanBtn.addEventListener('click', () => {
    const t = targetInput.value.trim();
    if (!t) { alert('Enter a domain or IP'); return; }
    doScan(t);
  });

  backBtn.addEventListener('click', () => {
    // hide results and reset UI
    results.style.display = 'none';
    message.textContent = 'No scan yet.';
    targetInput.value = '';
    targetInput.disabled = false;
    scanBtn.disabled = false;
    openReport.style.display = 'none';
  });
</script>
{% endblock %}
